name: Rollback Synced Releases Only

on:
  workflow_dispatch:

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # å¿…é¡»ï¼Œæ‰èƒ½åˆ  tag

      - name: Install gh & jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Find synced releases
        run: |
          echo "ğŸ” æŸ¥æ‰¾ç”± GitHub Actions åŒæ­¥åˆ›å»ºçš„ releases..."
          gh api /repos/${{ github.repository }}/releases > releases.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete synced releases and tags
        run: |
          jq -c '.[]' releases.json | while read -r rel; do
            id=$(echo "$rel" | jq -r '.id')
            tag=$(echo "$rel" | jq -r '.tag_name')
            author=$(echo "$rel" | jq -r '.author.login // ""')
            body=$(echo "$rel" | jq -r '.body // ""')

            if echo "$author" | grep -q "github-actions" \
               || echo "$body" | grep -qi "Synced from upstream"; then
              echo "ğŸ—‘ åˆ é™¤åŒæ­¥ Release: $tag"
              gh api -X DELETE /repos/${{ github.repository }}/releases/$id

              echo "ğŸ—‘ åˆ é™¤å¯¹åº” Tag: $tag"
              git push origin ":refs/tags/$tag"
            else
              echo "âœ… ä¿ç•™åŸæœ‰ Release: $tag"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
